name: PR Checks
on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  pr-size-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      # Check PR size
      - name: Check PR Size
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;
            
            let label = '';
            let message = '';
            
            if (total < 50) {
              label = 'size: xs';
              message = `✅ PR size: ${total} lines - excellent for review`;
            } else if (total < 200) {
              label = 'size: s';
              message = `✅ PR size: ${total} lines - good size for review`;
            } else if (total < 400) {
              label = 'size: m';
              message = `⚠️ PR size: ${total} lines - moderate size, still manageable`;
            } else if (total < 800) {
              label = 'size: l';
              message = `⚠️ PR size: ${total} lines - consider breaking into smaller PRs for easier review`;
              core.warning(`This PR has ${total} lines changed. Consider breaking it into smaller PRs for easier review.`);
            } else {
              label = 'size: xl';
              message = `🚨 PR size: ${total} lines - please break into smaller PRs for better review quality`;
              core.warning(`This PR has ${total} lines changed. Please break it into smaller PRs for easier review.`);
            }
            
            console.log(message);
            
            // Try to add size label (soft fail if permissions issue)
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [label]
              });
              console.log(`Successfully added label: ${label}`);
            } catch (error) {
              console.log(`Could not add label ${label}: ${error.message}`);
              core.warning(`PR size is ${label.replace('size: ', '')} (${total} lines). ${message}`);
            }

  basic-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check PR has description
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr.body || pr.body.trim().length < 10) {
              core.setFailed('PR description is too short. Please add a meaningful description.');
            } else {
              console.log('✅ PR has adequate description');
            }
      
      - name: Check for linked issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const hasLinkedIssue = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i.test(body);
            
            if (!hasLinkedIssue) {
              core.warning('💡 Consider linking this PR to an issue using "Closes #123" or "Fixes #123"');
            } else {
              console.log('✅ PR is linked to an issue');
            }
      
      - name: Check commit message format
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            
            // MOSD conventional commit format: type(scope): description
            const conventionalPattern = /^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+/;
            
            if (!conventionalPattern.test(title)) {
              core.warning(`💡 PR title doesn't follow MOSD conventional commit format: type(scope): description
              
Examples:
- feat(dashboard): add user profile component
- fix(web): resolve form validation issue
- docs(readme): update installation instructions

Soft recommendation: Include issue ID if branch fixes multiple issues.`);
            } else {
              console.log('✅ PR title follows conventional commit format');
            }