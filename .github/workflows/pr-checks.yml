name: PR Checks
on:
  pull_request:
    types: [opened, synchronize, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  pr-size-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      # Check PR size
      - name: Check PR Size
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;
            
            let label = '';
            let message = '';
            
            if (total < 50) {
              label = 'size: xs';
              message = `âœ… PR size: ${total} lines - excellent for review`;
            } else if (total < 200) {
              label = 'size: s';
              message = `âœ… PR size: ${total} lines - good size for review`;
            } else if (total < 400) {
              label = 'size: m';
              message = `âš ï¸ PR size: ${total} lines - moderate size, still manageable`;
            } else if (total < 800) {
              label = 'size: l';
              message = `âš ï¸ PR size: ${total} lines - consider breaking into smaller PRs for easier review`;
              core.warning(`This PR has ${total} lines changed. Consider breaking it into smaller PRs for easier review.`);
            } else {
              label = 'size: xl';
              message = `ðŸš¨ PR size: ${total} lines - please break into smaller PRs for better review quality`;
              core.warning(`This PR has ${total} lines changed. Please break it into smaller PRs for easier review.`);
            }
            
            console.log(message);
            
            // Try to add size label (soft fail if permissions issue)
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [label]
              });
              console.log(`âœ… Successfully added label: ${label}`);
            } catch (error) {
              console.log(`âš ï¸ Could not add label ${label}: ${error.message}`);
              if (error.status === 403) {
                console.log('â„¹ï¸ This is likely due to insufficient permissions for the GITHUB_TOKEN');
                console.log('â„¹ï¸ In a real project, you would configure repository permissions or use a PAT');
              }
              // Still show the size information even if labeling fails
              core.notice(`${message} (Label: ${label})`);
            }

  basic-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check PR has description
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const trimmedBody = body.trim();
            
            console.log(`PR body length: ${trimmedBody.length} characters`);
            console.log(`PR body content: "${trimmedBody.substring(0, 50)}..."`);
            
            if (!trimmedBody || trimmedBody.length < 10) {
              console.log('âŒ PR description validation failed');
              core.setFailed(`PR description is too short (${trimmedBody.length} characters). Please add a meaningful description with at least 10 characters.`);
              return;
            }
            
            console.log('âœ… PR has adequate description');
            
            // Additional check for template usage
            if (!trimmedBody.includes('## Description') && !trimmedBody.includes('## What does this PR do')) {
              core.warning('ðŸ’¡ Consider using the PR template for better structure');
            }
      
      - name: Check for linked issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const hasLinkedIssue = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i.test(body);
            
            if (!hasLinkedIssue) {
              core.warning('ðŸ’¡ Consider linking this PR to an issue using "Closes #123" or "Fixes #123"');
            } else {
              console.log('âœ… PR is linked to an issue');
            }
      
      - name: Check commit message format
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            
            // MOSD conventional commit format: type(scope): description
            const conventionalPattern = /^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+/;
            
            if (!conventionalPattern.test(title)) {
              const message = [
                'ðŸ’¡ PR title doesn\'t follow MOSD conventional commit format: type(scope): description',
                '',
                'Examples:',
                '- feat(dashboard): add user profile component',
                '- fix(web): resolve form validation issue', 
                '- docs(readme): update installation instructions',
                '',
                'Soft recommendation: Include issue ID if branch fixes multiple issues.'
              ].join('\n');
              core.warning(message);
            } else {
              console.log('âœ… PR title follows conventional commit format');
            }